<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kero Assistance - Home</title>
    <link rel="icon" type="image/png" href="favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root { --primary-color: #005c97; --secondary-color: #363795; --success-color: #28a745; --error-color: #dc3545; --info-color: #17a2b8; --light-bg: #f8f9fa; --dark-text: #343a40; --light-text: #6c757d; --border-color: #dee2e6; }
        body { font-family: 'Poppins', sans-serif; background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: var(--dark-text); -webkit-font-smoothing: antialiased; }
        .container { background-color: #ffffff; border-radius: 20px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08); padding: 40px; width: 100%; max-width: 800px; text-align: center; margin-top: 20px; margin-bottom: 20px; position: relative; border: 1px solid var(--border-color); }
        .page { display: none; }
        h1 { color: var(--dark-text); margin-bottom: 8px; font-weight: 700; }
        #kero-assistance { font-size: 2.5em; }
        .subtitle { font-size: 1.8em; font-weight: 600; color: var(--primary-color); }
        .container > p { color: var(--light-text); font-size: 1.1em; margin-bottom: 30px; }
        .section { margin-bottom: 30px; padding: 25px 0; border: none; border-top: 1px solid var(--border-color); background-color: transparent; }
        .instructions { font-size: 0.9em; color: #0c5460; background-color: #d1ecf1; padding: 15px; border-radius: 8px; border: 1px solid #bee5eb; margin-bottom: 25px; text-align: left; }
        .instructions strong { color: #004085; }
        .location-container { display: flex; gap: 20px; justify-content: center; align-items: center; margin-bottom: 15px; }
        .file-upload-area { border: 2px dashed var(--border-color); padding: 20px; border-radius: 10px; margin-bottom: 20px; background-color: var(--light-bg); }
        .file-upload-area strong { color: var(--primary-color); }
        input[type="file"] { display: none; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; margin: 5px; transition: all 0.25s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 92, 151, 0.2); }
        button:disabled { background-color: #ced4da; cursor: not-allowed; transform: none; box-shadow: none; }
        .main-action-button { font-size: 1.1rem; font-weight: 600; padding: 15px 35px; background-color: var(--success-color); }
        .main-action-button:hover:not(:disabled) { box-shadow: 0 6px 12px rgba(40, 167, 69, 0.25); }
        .home-button { display: flex; align-items: center; justify-content: center; width: 100%; margin: 15px 0; padding: 20px; font-size: 1.2em; font-weight: 600; background-color: #fff; color: var(--primary-color); border: 2px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.04); }
        .home-button:hover { border-color: var(--primary-color); background-color: #f8f9fa; color: var(--secondary-color); transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.08); }
        .home-nav-button { background-color: var(--light-text); position: absolute; top: 25px; left: 25px; padding: 8px 16px; }
        .home-nav-button:hover { background-color: var(--dark-text); }
        .message-display { margin-top: 20px; font-weight: 500; min-height: 1.2em; padding: 12px 18px; border-radius: 8px; text-align: left; border: 1px solid transparent; word-break: break-word; }
        .message-display:before { font-weight: 700; margin-right: 10px; }
        .message-display.success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        .message-display.success:before { content: "✔"; }
        .message-display.info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
        .message-display.info:before { content: "ℹ"; }
        .message-display.error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        .message-display.error:before { content: "⚠"; }
        .select2-container--default .select2-selection--single { border: 1px solid var(--border-color) !important; border-radius: 8px !important; height: 45px !important; padding: 8px 12px !important; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { color: var(--dark-text) !important; line-height: 28px !important; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 43px !important; }
        .select2-dropdown { border: 1px solid var(--border-color) !important; border-radius: 8px !important; box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        .version { position: fixed; bottom: 10px; right: 10px; font-size: 0.8em; color: #fff; background-color: rgba(0, 0, 0, 0.4); padding: 4px 8px; border-radius: 12px; }
        .output-toggle-container { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; color: var(--dark-text); font-weight: 500;}
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div class="version">v14.0 Final Fix</div>

    <div id="homePage" class="container page">
        <h1><span id="kero-assistance">Kero Assistance</span></h1>
        <p> Please select a tool.</p>
        <div class="section">
            <button id="goToTransferBtn" class="home-button">Stock Transfer</button>
            <button id="goToValidatorBtn" class="home-button">Barcode Validator & Retriever</button>
            <button id="goToConfirmBtn" class="home-button">Transfer Confirmation & Reconciliation</button>
        </div>
        <div class="message-display info">Ready to go!</div>
    </div>
    
    <div id="stockTransferPage" class="container page">
        <button class="go-home-btn home-nav-button">Back to Home</button>
        <h1><span class="subtitle">Stock Transfer Management</span></h1>
        <div class="section">
            <div class="instructions"><strong>Instructions:</strong> Upload an Excel file (`.xlsx`). The first sheet must contain a '<strong>code</strong>' column, followed by columns where the header is the destination branch code/ID and the cells contain the quantity to transfer.</div>
            <div class="location-container">
                <select id="locationFrom" class="location-select"></select>
            </div>
            <input type="file" id="quantityFile" accept=".xlsx">
            <button id="uploadQuantityButton">Upload Transfer File</button>
            <button id="clearQuantity">Clear File</button>
        </div>
        <div class="output-toggle-container">
            <span>Consolidated File</span>
            <label class="switch">
                <input type="checkbox" id="outputFormatToggle">
                <span class="slider"></span>
            </label>
            <span>Separated Files (ZIP)</span>
        </div>
        <button id="processTransferButton" class="main-action-button">Process Transfers and Download</button>
        <div class="message-display"></div>
    </div>

    <div id="barcodeValidatorPage" class="container page">
        <button class="go-home-btn home-nav-button">Back to Home</button>
        <h1><span class="subtitle">Item & Barcode Check</span></h1>
        <div class="section">
            <div class="instructions"><strong>Instructions:</strong> Upload an Excel file (`.xlsx`). Data **must be on the first sheet** and contain a column with the header: <strong>barcode</strong>.</div>
            <input type="file" id="barcodeFile" accept=".xlsx">
            <button id="uploadBarcodeButton">Upload Barcode File</button>
            <button id="clearBarcodes">Clear Barcodes</button>
        </div>
        <button id="validateDownloadButton" class="main-action-button">Validate Barcodes and Download</button>
        <div class="message-display"></div>
    </div>

    <div id="transferConfirmationPage" class="container page">
        <button class="go-home-btn home-nav-button">Back to Home</button>
        <h1><span class="subtitle">Transfer Confirmation & Reconciliation</span></h1>
        <div class="section">
            <div class="instructions">
                <strong>Instructions:</strong>
                <ol>
                    <li>Generate the transfer file and send it to the branch manager.</li>
                    <li>The manager **must add a new column named 'Transferred Quantity'** to the file and fill in the quantities.</li>
                    <li>Upload that single, updated Excel file below to generate the report.</li>
                </ol>
            </div>
            <div class="file-upload-area">
                <strong>Upload Completed Transfer File</strong>
                <p id="reconciliationFileName">No file selected.</p>
                <input type="file" id="reconciliationFile" accept=".xlsx">
                <button id="uploadReconciliationButton">Select Reconciliation File</button>
                <button id="clearReconciliation">Clear File</button>
            </div>
        </div>
        <button id="processConfirmationButton" class="main-action-button">Generate Reconciliation Report</button>
        <div class="message-display"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxBUnVmysM6WSP1uW3ittU2eU3HxwGax2QlwhXd3cbt3sIMsDEnTCcDCInCk-nOAB7wmw/exec';
        const GOOGLE_SHEET_NAME_TO_USE = 'Products';

        let transferListData = null;
        let barcodeData = null;
        let reconciliationData = null;

        const locations = [
            { id: "جاردنز 101", text: "جاردنز 101" }, { id: "تلال السخنة 102", text: "تلال السخنة 102" },
            { id: "ستيلا 103", text: "ستيلا 103" }, { id: "الدبلو 104", text: "الدبلو 104" },
            { id: "تلال الساحل 105", text: "تلال الساحل 105" }, { id: "سوان لك 106", text: "سوان لك 106" },
            { id: "كاسكادا 107", text: "كاسكادا 107" }, { id: "لافيستا باي 108", text: "لافيستا باي 108" },
            { id: "راس الحكمة 109", text: "راس الحكمة 109" }, { id: "لازوردي 110", text: "لازوردي 110" },
            { id: "النادي 111", text: "النادي 111" }, { id: "زايد 112", text: "زايد 112" },
            { id: "القطامية 115", text: "القطامية 115" }, { id: "مخزن بلبيس 201", text: "مخزن بلبيс 201" },
            { id: "مخزن الساحل 202", text: "مخزن الساحل 202" },{ id: "فوكا باي 117", text: "فوكا باي 117" },
        ];

        const branchCodeToNameMap = new Map();
        locations.forEach(location => {
            const match = location.id.match(/\d+$/);
            if (match) { branchCodeToNameMap.set(match[0], location.text); }
        });

        document.addEventListener('DOMContentLoaded', function() {
            showPage('homePage');
            const locationOptions = [{ id: '', text: 'Select Source Location' }, ...locations];
            $('#locationFrom').select2({ data: locationOptions });
            document.getElementById('goToTransferBtn').addEventListener('click', () => showPage('stockTransferPage'));
            document.getElementById('goToValidatorBtn').addEventListener('click', () => showPage('barcodeValidatorPage'));
            document.querySelectorAll('.go-home-btn').forEach(button => button.addEventListener('click', () => showPage('homePage')));
            document.getElementById('uploadQuantityButton').addEventListener('click', () => document.getElementById('quantityFile').click());
            document.getElementById('quantityFile').addEventListener('change', handleFileUpload);
            document.getElementById('clearQuantity').addEventListener('click', clearQuantity);
            document.getElementById('processTransferButton').addEventListener('click', processTransferData);
            document.getElementById('uploadBarcodeButton').addEventListener('click', () => document.getElementById('barcodeFile').click());
            document.getElementById('barcodeFile').addEventListener('change', handleFileUpload);
            document.getElementById('clearBarcodes').addEventListener('click', clearBarcodes);
            document.getElementById('validateDownloadButton').addEventListener('click', processAndValidateBarcodes);
            document.getElementById('goToConfirmBtn').addEventListener('click', () => showPage('transferConfirmationPage'));
            document.getElementById('uploadReconciliationButton').addEventListener('click', () => document.getElementById('reconciliationFile').click());
            document.getElementById('reconciliationFile').addEventListener('change', handleFileUpload);
            document.getElementById('processConfirmationButton').addEventListener('click', processConfirmation);
            document.getElementById('clearReconciliation').addEventListener('click', clearReconciliation);
        });
        
        function clearQuantity() { transferListData = null; document.getElementById('quantityFile').value = ''; showMessage('Transfer file has been cleared.', 'info'); }
        function clearBarcodes() { barcodeData = null; document.getElementById('barcodeFile').value = ''; showMessage('Barcode file has been cleared.', 'info'); }
        function clearReconciliation() { reconciliationData = null; document.getElementById('reconciliationFile').value = ''; document.getElementById('reconciliationFileName').textContent = 'No file selected.'; showMessage('Reconciliation file has been cleared.', 'info'); }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const targetId = event.target.id;
            const fileTypeConfig = {
                'quantityFile': { type: 'transferList', requiredHeaders: ['code'], dataVar: 'transferListData', clearFunc: clearQuantity },
                'barcodeFile': { type: 'barcode', requiredHeaders: ['barcode'], dataVar: 'barcodeData', clearFunc: clearBarcodes },
                'reconciliationFile': { type: 'reconciliation', requiredHeaders: ['code', 'quantity', 'transferred quantity'], dataVar: 'reconciliationData', clearFunc: clearReconciliation }
            };
            const config = fileTypeConfig[targetId];

            if (!file || !config) return;
            
            config.clearFunc();
            const fileNameDisplayElement = document.getElementById(`${targetId.replace('File', '')}FileName`);
            if (fileNameDisplayElement) {
                fileNameDisplayElement.textContent = `Validating ${file.name}...`;
            }
            showMessage(`Reading and validating file...`, 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) throw new Error("File is invalid. The Excel workbook contains no sheets.");
                    
                    let parsedData;

                    if (config.type === 'reconciliation') {
                        let allSheetsData = [];
                        workbook.SheetNames.forEach(sheetName => {
                            if (sheetName.toLowerCase().includes("unmatched")) return;
                            const worksheet = workbook.Sheets[sheetName];
                            const rows = XLSX.utils.sheet_to_json(worksheet, { defval: null });
                            allSheetsData.push(...rows.map(row => ({ ...row, branch: sheetName })));
                        });
                        
                        if (allSheetsData.length === 0) throw new Error("File is invalid. No data rows were found in any of the sheets.");
                        
                        const headers = Object.keys(allSheetsData[0]).map(h => String(h || '').toLowerCase().trim());
                        
                        const missingHeaders = config.requiredHeaders.filter(h => !headers.includes(h));
                        if (missingHeaders.length > 0) {
                            throw new Error(`Upload Failed: The file is missing the required column(s): [${missingHeaders.join(', ')}]. Please ensure the manager added the 'Transferred Quantity' column.`);
                        }
                        parsedData = allSheetsData.map(row => { const newRow = {}; for (const key in row) { newRow[key.toLowerCase().trim()] = row[key]; } return newRow; });
                    } else {
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rowsAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });
                        if (rowsAsArray.length < 2) throw new Error(`The first sheet is empty or contains only a header.`);
                        const headerRow = rowsAsArray[0].map(h => String(h || '').toLowerCase().trim());
                        const dataRows = rowsAsArray.slice(1);
                        if (config.type === 'transferList') {
                            if (!headerRow || headerRow.length < 2 || headerRow[0] !== 'code') throw new Error("Invalid transfer file format. First column must be 'code'.");
                            const flattenedData = [];
                            dataRows.forEach((row) => { const itemCode = row[0]; if (!itemCode || String(itemCode).trim() === '') return; headerRow.slice(1).forEach((branch, colIndex) => { const quantity = row[colIndex + 1]; if (quantity !== null && quantity !== '' && !isNaN(quantity) && Number(quantity) > 0) { flattenedData.push({ code: String(itemCode).trim(), branch: String(branch).trim(), quantity: Number(quantity) }); } }); });
                            if (flattenedData.length === 0) throw new Error(`File uploaded, but no valid transfer quantities were found.`);
                            parsedData = flattenedData;
                        } else if (config.type === 'barcode') {
                            const headerMap = {}; headerRow.forEach((h, i) => { headerMap[h] = i; });
                            const missingHeaders = config.requiredHeaders.filter(h => headerMap[h] === undefined);
                            if (missingHeaders.length > 0) throw new Error(`File is missing required column(s): [${missingHeaders.join(', ')}].`);
                            const jsonData = dataRows.map(row => ({ barcode: String(row[headerMap['barcode']] || '').trim() })).filter(obj => obj.barcode !== "");
                            if (jsonData.length === 0) throw new Error(`File contains no data rows.`);
                            parsedData = jsonData;
                        }
                    }
                    
                    window[config.dataVar] = parsedData;
                    if (fileNameDisplayElement) { fileNameDisplayElement.textContent = file.name; }
                    showMessage(`${file.name} uploaded and validated successfully. Ready to generate report.`, 'success');

                } catch (error) {
                    showMessage(error.message, 'error');
                    config.clearFunc();
                } finally {
                    event.target.value = '';
                }
            };
            reader.onerror = () => {
                showMessage(`Fatal Error: Could not read the file.`, 'error');
                config.clearFunc();
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processConfirmation() {
            if (!reconciliationData) {
                showMessage('Error: Please upload a valid and completed reconciliation file first.', 'error');
                return;
            }
            const button = document.getElementById('processConfirmationButton');
            button.disabled = true;
            showMessage('Processing... Analyzing file and generating report.', 'info');
            try {
                const reconciliationResults = reconciliationData.map(item => {
                    const requestedQty = Number(item['quantity']) || 0;
                    const transferredQty = Number(item['transferred quantity']) || 0;
                    const discrepancy = requestedQty - transferredQty;
                    let status = '';
                    if (discrepancy === 0) status = 'Fully Transferred';
                    else if (transferredQty === 0) status = 'Not Transferred';
                    else if (discrepancy > 0) status = 'Partially Transferred';
                    else status = 'Over Transferred';
                    return { 'Branch': item['branch'], 'Code': item['code'], 'Barcode': item['barcode'], 'Name': item['name'], 'Requested Qty': requestedQty, 'Transferred Qty': transferredQty, 'Discrepancy': discrepancy, 'Status': status, };
                });
                const wb = XLSX.utils.book_new();
                const branchAnalysis = {};
                reconciliationResults.forEach(item => {
                    const branchName = item.Branch;
                    if (!branchName) return;
                    if (!branchAnalysis[branchName]) {
                        branchAnalysis[branchName] = { requested: 0, transferred: 0 };
                    }
                    branchAnalysis[branchName].requested += item['Requested Qty'];
                    branchAnalysis[branchName].transferred += item['Transferred Qty'];
                });
                const analysisSheetData = Object.keys(branchAnalysis).map(branchName => {
                    const data = branchAnalysis[branchName];
                    const rate = data.requested > 0 ? (data.transferred / data.requested) : 0;
                    return { 'Branch': branchName, 'Total Qty Requested': data.requested, 'Total Qty Transferred': data.transferred, 'Fulfillment Rate': rate, };
                });
                let wsAnalysis = XLSX.utils.json_to_sheet(analysisSheetData);
                wsAnalysis['!cols'] = [{ wch: 30 }, { wch: 20 }, { wch: 22 }, { wch: 18 }];
                const range = XLSX.utils.decode_range(wsAnalysis['!ref']);
                for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                    const cell_ref = XLSX.utils.encode_cell({ c: 3, r: R });
                    if (wsAnalysis[cell_ref]) { wsAnalysis[cell_ref].z = '0.00%'; }
                }
                applyStylesToWorksheet(wsAnalysis);
                XLSX.utils.book_append_sheet(wb, wsAnalysis, "Branch Fulfillment Analysis");
                const discrepancyResults = reconciliationResults.filter(item => item.Status !== 'Fully Transferred');
                if (discrepancyResults.length > 0) {
                    let wsDiscrepancy = XLSX.utils.json_to_sheet(discrepancyResults, { header: ['Branch', 'Code', 'Barcode', 'Name', 'Requested Qty', 'Transferred Qty', 'Discrepancy', 'Status'] });
                    wsDiscrepancy['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }];
                    applyStylesToWorksheet(wsDiscrepancy);
                    XLSX.utils.book_append_sheet(wb, wsDiscrepancy, "Discrepancy Report");
                }
                let wsFull = XLSX.utils.json_to_sheet(reconciliationResults, { header: ['Branch', 'Code', 'Barcode', 'Name', 'Requested Qty', 'Transferred Qty', 'Discrepancy', 'Status'] });
                wsFull['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }];
                applyStylesToWorksheet(wsFull);
                XLSX.utils.book_append_sheet(wb, wsFull, "Full Reconciliation Report");
                const formattedDate = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `Transfer_Reconciliation_Report_${formattedDate}.xlsx`);
                showMessage('Success! Report with branch analysis and discrepancy details has been downloaded.', 'success');
            } catch (error) {
                showMessage(`Processing Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
            }
        }

        async function processTransferData(){if(SCRIPT_URL.includes('PASTE_YOUR_NEW_DEPLOYED_WEB_APP_URL_HERE'))return showMessage('Configuration Error: The SCRIPT_URL has not been set in the HTML file.','error');if(!transferListData)return showMessage('Error: Please upload a Transfer file.','error');const locationFrom=document.getElementById('locationFrom').value;if(!locationFrom)return showMessage('Error: Please select the "From" location.','error');const isSeparated=document.getElementById('outputFormatToggle').checked;const button=document.getElementById('processTransferButton');button.disabled=true;showMessage(`Processing ${transferListData.length} items... Fetching details.`,'info');try{const uniqueCodes=[...new Set(transferListData.map(item=>item.code))];const payloadForServer={action:'processTransfer',sheetName:GOOGLE_SHEET_NAME_TO_USE,payload:uniqueCodes.map(code=>({code:code}))};const response=await fetch(SCRIPT_URL,{method:'POST',mode:'cors',body:JSON.stringify(payloadForServer)});if(!response.ok)throw new Error(`Server returned an error: ${response.statusText}`);const result=await response.json();if(result.status==='error')throw new Error(result.message);const itemDetailsMap=new Map();result.results.forEach(itemArray=>{const[code,barcode,name]=itemArray;itemDetailsMap.set(String(code),{barcode,name})});const transfersByBranch=transferListData.reduce((acc,item)=>{const{branch,code,quantity}=item;if(!acc[branch])acc[branch]=[];const details=itemDetailsMap.get(code);if(details)acc[branch].push({code,quantity,...details});return acc},{});const unmatchedCodes=uniqueCodes.filter(code=>!itemDetailsMap.has(code));const formattedDate=new Date().toISOString().slice(0,10);if(isSeparated){const zip=new JSZip();const sheetHeader=["Transfer Order ID","Code","Barcode","Name","Quantity"];for(const branchCode in transfersByBranch){const branchSerialNumber=Math.floor(1000+Math.random()*9000);const itemsForBranch=transfersByBranch[branchCode];const sheetData=itemsForBranch.map(item=>[branchSerialNumber,item.code,item.barcode,item.name,item.quantity]);const wb=XLSX.utils.book_new();let ws=XLSX.utils.aoa_to_sheet([sheetHeader,...sheetData]);ws['!cols']=[{wch:18},{wch:15},{wch:20},{wch:50},{wch:10}];applyStylesToWorksheet(ws);XLSX.utils.book_append_sheet(wb,ws,"Transfer Data");const fullBranchName=branchCodeToNameMap.get(branchCode)||branchCode;const fileName=`Transfer to ${fullBranchName} #${branchSerialNumber}.xlsx`;const excelBuffer=XLSX.write(wb,{bookType:'xlsx',type:'array'});zip.file(fileName,excelBuffer)}if(unmatchedCodes.length>0){const wb=XLSX.utils.book_new();let wsUnmatched=XLSX.utils.aoa_to_sheet([["Code","Reason"],...unmatchedCodes.map(code=>[code,"Code not found"])]);wsUnmatched['!cols']=[{wch:15},{wch:40}];applyStylesToWorksheet(wsUnmatched);XLSX.utils.book_append_sheet(wb,wsUnmatched,"Unmatched Codes");const excelBuffer=XLSX.write(wb,{bookType:'xlsx',type:'array'});zip.file("Unmatched Codes.xlsx",excelBuffer)}const zipFileName=`Transfers from ${locationFrom} ${formattedDate}.zip`;zip.generateAsync({type:'blob'}).then(function(content){const link=document.createElement('a');link.href=URL.createObjectURL(content);link.download=zipFileName;document.body.appendChild(link);link.click();document.body.removeChild(link)});showMessage(`Success! A zip file with all unique transfer orders has been downloaded.`,'success')}else{const wb=XLSX.utils.book_new();const sheetHeader=["Transfer Order ID","Code","Barcode","Name","Quantity"];for(const branchCode in transfersByBranch){const branchSerialNumber=Math.floor(1000+Math.random()*9000);const itemsForBranch=transfersByBranch[branchCode];const sheetData=itemsForBranch.map(item=>[branchSerialNumber,item.code,item.barcode,item.name,item.quantity]);let ws=XLSX.utils.aoa_to_sheet([sheetHeader,...sheetData]);ws['!cols']=[{wch:18},{wch:15},{wch:20},{wch:50},{wch:10}];applyStylesToWorksheet(ws);const fullBranchName=branchCodeToNameMap.get(branchCode)||branchCode;const sheetName=`To ${fullBranchName}`;XLSX.utils.book_append_sheet(wb,ws,sheetName)}if(unmatchedCodes.length>0){const wb=XLSX.utils.book_new();let wsUnmatched=XLSX.utils.aoa_to_sheet([["Code","Reason"],...unmatchedCodes.map(code=>[code,"Code not found"])]);wsUnmatched['!cols']=[{wch:15},{wch:40}];applyStylesToWorksheet(wsUnmatched);XLSX.utils.book_append_sheet(wb,wsUnmatched,"Unmatched Codes")}const fileName=`Transfers from ${locationFrom} ${formattedDate}.xlsx`;XLSX.writeFile(wb,fileName);showMessage(`Success! Consolidated file with unique transfer IDs per branch has been downloaded.`,'success')}}catch(error){showMessage(`Processing Error: ${error.message}`,'error')}finally{button.disabled=false}}
        function showPage(pageId){document.querySelectorAll('.page').forEach(p=>{p.style.display='none'});const n=document.getElementById(pageId);if(n){n.style.display='block';const m=n.querySelector('.message-display');if(m){m.innerText='';m.className='message-display'}}}
        function applyStylesToWorksheet(ws){const border={top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'}};const headerStyle={font:{bold:true},fill:{fgColor:{rgb:"E9E9E9"}},border:border,alignment:{horizontal:'center'}};const cellStyle={border:border};const range=XLSX.utils.decode_range(ws['!ref']);for(let R=range.s.r;R<=range.e.r;++R){for(let C=range.s.c;C<=range.e.c;++C){const cell_address={c:C,r:R};const cell_ref=XLSX.utils.encode_cell(cell_address);if(!ws[cell_ref])continue;if(R===0){ws[cell_ref].s=headerStyle}else{ws[cell_ref].s=cellStyle}}}ws['!pageSetup']={orientation:'landscape',fitToWidth:1,fitToHeight:0}}
        async function processAndValidateBarcodes(){if(SCRIPT_URL.includes('PASTE_YOUR_NEW_DEPLOYED_WEB_APP_URL_HERE'))return showMessage('Configuration Error: The SCRIPT_URL has not been set in the HTML file.','error');if(!barcodeData)return showMessage('Error: Please upload a Barcode file.','error');const button=document.getElementById('validateDownloadButton');button.disabled=true;showMessage(`Validating ${barcodeData.length} barcodes on server... Please wait.`,'info');try{const payloadForServer={action:'validateBarcodes',sheetName:GOOGLE_SHEET_NAME_TO_USE,payload:barcodeData.map(row=>String(row.barcode).trim())};const response=await fetch(SCRIPT_URL,{method:'POST',mode:'cors',body:JSON.stringify(payloadForServer)});if(!response.ok)throw new Error(`Server returned an error: ${response.statusText}`);const result=await response.json();if(result.status==='error')throw new Error(result.message);const wb=XLSX.utils.book_new();const header=["Barcode","Validation Status","Code","Name","Supplier"];let ws=XLSX.utils.aoa_to_sheet([header,...result.results]);ws['!cols']=[{wch:20},{wch:20},{wch:15},{wch:50},{wch:30}];applyStylesToWorksheet(ws);XLSX.utils.book_append_sheet(wb,ws,"Validation Results");const formattedDate=new Date().toISOString().slice(0,10);XLSX.writeFile(wb,`Barcode_Validation_Results_${formattedDate}.xlsx`);showMessage('Success! Barcodes validated and results downloaded.','success')}catch(error){showMessage(`Processing Error: ${error.message}`,'error')}finally{button.disabled=false}}
        function showMessage(message,type='info'){let messageDiv=document.querySelector('.page[style*="block"] .message-display');if(!messageDiv){messageDiv=document.querySelector('#homePage .message-display')}if(!messageDiv)return;messageDiv.innerText=message;messageDiv.className='message-display';if(type==='success'){messageDiv.classList.add('success')}else if(type==='error'){messageDiv.classList.add('error')}else if(type==='info'){messageDiv.classList.add('info')}}
    </script>
</body>
</html>
