<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طلب إعادة التزويد</title>
    
    <!-- Libraries CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <style>
        body { background-color: #f8f9fa; font-size: 14px; }
        .card { box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        #itemsTable thead { background-color: #e9ecef; }
        .table-danger { --bs-table-bg: #f8d7da; --bs-table-border-color: #f5c2c7; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3">جاري تحميل البيانات...</p>
    </div>

    <div class="container mt-3 mb-3">
        <h3 class="text-center mb-3">إنشاء طلب إعادة تزويد</h3>
        <div class="card">
            <div class="card-body">
                <div class="row mb-3 g-2">
                    <div class="col-12 mb-2">
                        <label for="branchName" class="form-label">اسم الفرع</label>
                        <input type="text" class="form-control" id="branchName" placeholder="مثال: فرع الرياض الرئيسي" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="supplierFilter" class="form-label">تصفية حسب المورد</label>
                        <select id="supplierFilter" class="form-select"></select>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="stockFilter" class="form-label">تصفية حسب المخزون</label>
                        <select id="stockFilter" class="form-select">
                            <option value="all">عرض الكل</option>
                            <option value="low" class="text-danger fw-bold">عرض المخزون المنخفض فقط</option>
                        </select>
                    </div>
                </div>

                <table id="itemsTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>الاسم</th>
                            <th>المورد</th>
                            <th>الكمية</th>
                            <th>الطلب</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <div class="d-grid">
                    <button id="reviewOrderBtn" class="btn btn-primary mt-3">مراجعة الطلب وإنشاء الملفات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Order Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">مراجعة الطلب النهائي</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>هذه هي الأصناف التي سيتم تضمينها في الملف. تأكد من صحة الكميات.</p>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>اسم الصنف</th>
                                <th>المورد</th>
                                <th>كمية الطلب</th>
                            </tr>
                        </thead>
                        <tbody id="reviewTableBody"></tbody>
                    </table>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success" onclick="downloadExcel()">
                        <i class="bi bi-file-earmark-excel"></i> تحميل كملف Excel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="downloadPDF()">
                        <i class="bi bi-file-earmark-pdf"></i> تحميل كملف PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    
    <!-- File Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Arabic Font for PDF (Amiri Font) -->
    <script src="https://raw.githack.com/MrRio/jsPDF/master/src/libs/rawdeflate.js"></script>
    <script src="https://raw.githack.com/MrRio/jsPDF/master/src/libs/UTF8.js"></script>
    <script src="https://raw.githack.com/someatoms/jsPDF-Amiri-font/master/Amiri-Regular.js"></script>

    <!-- App Logic -->
    <script>
        // ==================================================================
        // PASTE YOUR **NEW**, SIMPLIFIED GOOGLE SCRIPT WEB APP URL HERE!
        // ==================================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbx8TLeHcNG_9AOA7w_kzwTgc37-Iloo1e5aHUTvecJ8dSLlOkHpCGJXmxPP6BnaovwlOQ/exec';
        // ==================================================================

        let allItems = [];
        let dataTable;
        let orderContainer = []; // This array will hold the items for the current order

        $(document).ready(function() {
            fetchItems();
            $('#reviewOrderBtn').on('click', reviewOrder);
        });

        function fetchItems() {
            $('#loading-overlay').show();
            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    allItems = data;
                    populateSupplierFilter(data);
                    renderTable(data);
                    $('#loading-overlay').hide();
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    $('#loading-overlay').html(`<div class="alert alert-danger">فشل في تحميل البيانات: ${error.message}</div>`);
                });
        }
        
        function renderTable(items) {
            if (dataTable) dataTable.destroy();
            const tableBody = $('#itemsTable tbody');
            tableBody.empty();
            items.forEach(item => {
                // Use the keys from your Google Sheet, which we replaced spaces with underscores
                const isLowStock = Number(item.quantity) <= Number(item.reorder_level);
                const rowClass = isLowStock ? 'table-danger' : '';
                const row = `
                    <tr class="${rowClass}" data-item='${JSON.stringify(item)}'>
                        <td><input type="checkbox" class="form-check-input item-checkbox"></td>
                        <td>${item.name || ''}</td>
                        <td>${item.supplier_name || ''}</td>
                        <td>${item.quantity || '0'}</td>
                        <td><input type="number" class="form-control order-quantity" min="0" placeholder="0" style="width: 80px;"></td>
                    </tr>`;
                tableBody.append(row);
            });
            dataTable = $('#itemsTable').DataTable({
                responsive: true,
                language: { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json" }
            });
        }

        function populateSupplierFilter(items) {
            // Using 'supplier_name' key
            const suppliers = [...new Set(items.map(item => item['supplier_name']))].sort();
            const filter = $('#supplierFilter');
            filter.html('<option value="all">كل الموردين</option>');
            suppliers.forEach(s => { if(s) filter.append(`<option value="${s}">${s}</option>`); });
        }

        // Add filter and select all logic (omitted for brevity, they are standard)

        function reviewOrder() {
            const branchName = $('#branchName').val().trim();
            if (!branchName) {
                alert('يرجى إدخال اسم الفرع أولاً.');
                return;
            }
            
            orderContainer = []; // Clear the container for a new order
            $('.item-checkbox:checked').each(function() {
                const row = $(this).closest('tr');
                const itemData = row.data('item');
                const orderQuantity = parseInt(row.find('.order-quantity').val());
                if (orderQuantity > 0) {
                    orderContainer.push({
                        "اسم الصنف": itemData.name,
                        "المورد": itemData.supplier_name,
                        "كود الصنف": itemData.code,
                        "كود المورد": itemData.supplier_code,
                        "كمية الطلب": orderQuantity
                    });
                }
            });

            if (orderContainer.length === 0) {
                alert('يرجى تحديد عنصر واحد على الأقل وكمية الطلب.');
                return;
            }

            // Populate and show the review modal
            const reviewBody = $('#reviewTableBody');
            reviewBody.empty();
            orderContainer.forEach(item => {
                reviewBody.append(`<tr><td>${item['اسم الصنف']}</td><td>${item['المورد']}</td><td>${item['كمية الطلب']}</td></tr>`);
            });
            const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
            reviewModal.show();
        }

        function downloadExcel() {
            const branchName = $('#branchName').val().trim();
            const filename = `Order_${branchName}_${new Date().toISOString().slice(0,10)}.xlsx`;
            
            const ws = XLSX.utils.json_to_sheet(orderContainer);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Order");
            XLSX.writeFile(wb, filename);
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const branchName = $('#branchName').val().trim();
            const title = `Resupply Order for: ${branchName}`;
            
            // Add Amiri font for Arabic support
            doc.addFileToVFS('Amiri-Regular.ttf', AmiriRegular);
            doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri');

            doc.text(title, 105, 15, null, null, 'center');
            
            doc.autoTable({
                startY: 25,
                head: [Object.keys(orderContainer[0])],
                body: orderContainer.map(item => Object.values(item)),
                styles: {
                    font: 'Amiri',
                    halign: 'center'
                },
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold'
                }
            });

            const filename = `Order_${branchName}_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(filename);
        }
    </script>
</body>
</html>