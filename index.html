<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طلب إعادة التزويد الذكي</title>
    
    <!-- Libraries CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" />

    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: none; }
        #itemsTable thead { background-color: #e9ecef; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #loading-overlay.active { opacity: 1; visibility: visible; }
        .select2-container--bootstrap-5 .select2-selection { font-size: 1rem; }
        .select2-dropdown { text-align: right; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 fs-5">جاري التحميل...</p>
    </div>
    <div class="container my-4">
        <h3 class="text-center mb-3">إنشاء طلب إعادة تزويد</h3>
        <div class="card">
            <div class="card-body p-4">
                <div class="row mb-3 g-3 align-items-end">
                    <div class="col-12"><label for="branchName" class="form-label fw-bold">اسم الفرع</label><input type="text" class="form-control" id="branchName" placeholder="مثال: فرع الرياض الرئيسي" required></div>
                    <div class="col-12 col-md-5">
                        <label for="supplierFilter" class="form-label">1. اختر مورد (اختياري)</label>
                        <select id="supplierFilter" class="form-select"></select>
                    </div>
                    <div class="col-12 col-md-5">
                        <label for="searchTerm" class="form-label">2. أو ابحث بالاسم، الكود، أو الباركود</label>
                        <input type="search" class="form-control" id="searchTerm" placeholder="أدخل عبارة بحث...">
                    </div>
                    <div class="col-12 col-md-2 d-grid">
                        <button id="searchBtn" class="btn btn-primary">بحث</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="itemsTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                        <thead><tr><th><input type="checkbox" id="selectAll"></th><th>الاسم</th><th>المورد</th><th>الكمية</th><th>الطلب</th></tr></thead>
                        <tbody><tr><td colspan="5" class="text-center">الرجاء اختيار مورد أو البحث لعرض الأصناف.</td></tr></tbody>
                    </table>
                </div>
                <div class="d-grid mt-3"><button id="reviewOrderBtn" class="btn btn-success btn-lg">مراجعة الطلب (<span id="selectionCount">0</span> أصناف)</button></div>
            </div>
        </div>
    </div>
    
    <!-- Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">مراجعة الطلب النهائي</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light"><tr><th>الباركود</th><th>اسم الصنف</th><th>المورد</th><th>كمية الطلب</th></tr></thead>
                        <tbody id="reviewTableBody"></tbody>
                    </table>
                </div>
                <div class="modal-footer justify-content-center gap-2">
                    <button type="button" class="btn btn-success" onclick="downloadExcel()">تحميل Excel</button>
                    <button type="button" class="btn btn-danger" onclick="downloadPDF()">تحميل PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    
    <!-- App Logic -->
    <script>
        // ==================================================================
        // PASTE YOUR **NEW** GOOGLE SCRIPT WEB APP URL HERE!
        // ==================================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxK_fKhO9QoLZTQcV5YaxisH-6lzulUsqigj44Ne8oiBZka0r2rDtApvPtJE9Q9U6GIbw/exec';
        // ==================================================================

        let dataTable;
        let selectionState = {}; 
        const loadingOverlay = $('#loading-overlay');

        $(document).ready(function() {
            initializeSuppliers();
            initializeDataTable();

            $('#supplierFilter').on('change', function() {
                const supplier = $(this).val();
                if (supplier) {
                    $('#searchTerm').val(''); 
                    fetchData({ supplier: supplier });
                }
            });

            $('#searchBtn').on('click', performSearch);
            $('#searchTerm').on('keypress', function(e) { if(e.which == 13) performSearch(); });
            
            $('#itemsTable tbody').on('change', '.item-checkbox', handleSelectionChange);
            $('#itemsTable tbody').on('input', '.order-quantity', handleSelectionChange);
            
            $('#reviewOrderBtn').on('click', reviewOrder);
        });

        function performSearch() {
            const term = $('#searchTerm').val().trim();
            if (term.length >= 2) {
                $('#supplierFilter').val(null).trigger('change'); 
                fetchData({ searchTerm: term });
            } else {
                alert('الرجاء إدخال حرفين على الأقل للبحث.');
            }
        }

        function initializeSuppliers() {
            loadingOverlay.addClass('active');
            fetch(`${API_URL}?action=getSuppliers`)
                .then(res => res.json())
                .then(suppliers => {
                    const select = $('#supplierFilter');
                    select.append(new Option('', ''));
                    suppliers.forEach(s => select.append(new Option(s, s)));
                    select.select2({
                        placeholder: "ابحث أو اختر مورد...",
                        theme: "bootstrap-5",
                        dir: "rtl",
                        allowClear: true
                    });
                    loadingOverlay.removeClass('active');
                });
        }
        
        function fetchData(params) {
            loadingOverlay.addClass('active');
            const url = new URL(API_URL);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    renderTable(data);
                    loadingOverlay.removeClass('active');
                });
        }

        function initializeDataTable() {
             dataTable = $('#itemsTable').DataTable({
                responsive: true,
                language: { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json", "emptyTable": "لم يتم العثور على نتائج." },
                pageLength: 50,
                data: [], 
                columns: [
                    { data: null, defaultContent: '<input type="checkbox" class="form-check-input item-checkbox">', orderable: false },
                    { data: 'name' },
                    { data: 'supplier_name' },
                    { data: 'quantity' },
                    { data: null, defaultContent: '<input type="number" class="form-control order-quantity" min="0" style="width: 80px;">', orderable: false }
                ],
                // This will prevent the error from showing as an alert
                "error": "DT_RowData" 
            });
        }

        function renderTable(data) {
            dataTable.clear();
            dataTable.rows.add(data);
            dataTable.rows().every(function() {
                const rowNode = this.node();
                const rowData = this.data();
                if (selectionState[rowData.barcode]) {
                    $(rowNode).find('.item-checkbox').prop('checked', true);
                    $(rowNode).find('.order-quantity').val(selectionState[rowData.barcode].quantity);
                }
            }).draw();
        }

        function handleSelectionChange(event) {
            const row = $(event.target).closest('tr');
            const rowData = dataTable.row(row).data();
            if(!rowData) return;
            const quantity = parseInt(row.find('.order-quantity').val()) || 0;
            const isChecked = row.find('.item-checkbox').prop('checked');
            
            if (isChecked && quantity > 0) {
                selectionState[rowData.barcode] = { itemData: rowData, quantity: quantity };
            } else {
                delete selectionState[rowData.barcode];
            }
            updateSelectionCount();
        }

        function updateSelectionCount() {
            $('#selectionCount').text(Object.keys(selectionState).length);
        }

        function reviewOrder() {
            if (Object.keys(selectionState).length === 0) {
                alert('لم يتم تحديد أي أصناف للطلب.');
                return;
            }
            const reviewBody = $('#reviewTableBody');
            reviewBody.empty();
            for (const barcode in selectionState) {
                const selection = selectionState[barcode];
                reviewBody.append(`<tr>
                    <td>${selection.itemData.barcode}</td>
                    <td>${selection.itemData.name}</td>
                    <td>${selection.itemData.supplier_name}</td>
                    <td>${selection.quantity}</td>
                </tr>`);
            }
            new bootstrap.Modal(document.getElementById('reviewModal')).show();
        }

        function getOrderDataForExport() {
            return Object.values(selectionState).map(sel => ({
                "الباركود": sel.itemData.barcode,
                "اسم الصنف": sel.itemData.name,
                "المورد": sel.itemData.supplier_name,
                "كود الصنف": sel.itemData.code,
                "كمية الطلب": sel.quantity
            }));
        }

        function downloadExcel() {
            const branchName = $('#branchName').val().trim();
            const filename = `Order_${branchName || 'NoName'}_${new Date().toISOString().slice(0,10)}.xlsx`;
            const data = getOrderDataForExport();
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Order");
            XLSX.writeFile(wb, filename);
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const branchName = $('#branchName').val().trim();
            const title = `Resupply Order for: ${branchName}`;
            
            doc.addFileToVFS('Amiri-Regular.ttf', AmiriRegular);
            doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri');

            doc.text(title, 105, 15, null, null, 'center');
            
            const data = getOrderDataForExport();
            doc.autoTable({
                startY: 25,
                head: [Object.keys(data[0])],
                body: data.map(item => Object.values(item)),
                styles: { font: 'Amiri', halign: 'center' },
                headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' }
            });

            const filename = `Order_${branchName || 'NoName'}_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(filename);
        }
        // Self-contained Amiri Font for PDF generation
        var AmiriRegular = 'AAEAAAARAQAABAAQRFNJRwAAAAAAA...[very long string]...AAAAA=';
    </script>
</body>
</html>
