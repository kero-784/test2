<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طباعة شيلف مجمع</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        
        :root {
            --bg-color: #f4f7fa; --preview-bg: #e2e8f0; --text-color: #334155;
            --primary-color: #3b82f6; --primary-hover: #2563eb; --card-bg: #ffffff;
            --border-color: #e2e8f0; --muted-text: #64748b;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07);
            --radius-md: 8px; --radius-lg: 12px; --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --label-item-font-size: 16px; --label-price-font-size: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Cairo', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            display: flex; height: 100vh; overflow: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        .app-container { display: flex; width: 100%; height: 100%; flex-direction: row-reverse; }

        .control-panel {
            width: 450px; min-width: 420px; background-color: var(--bg-color);
            padding: 30px; height: 100vh; overflow-y: auto; border-left: 1px solid var(--border-color);
        }
        .preview-panel {
            flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 30px; height: 100vh; background-color: var(--preview-bg);
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 15px 15px;
        }

        h1 { font-size: 2rem; font-weight: 700; color: var(--text-color); margin-bottom: 25px; }
        h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        h3 { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin: 40px 0 25px 0; border-bottom: 2px solid; padding-bottom: 15px;}

        button {
            background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: var(--radius-md); font-family: 'Cairo', sans-serif;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition); box-shadow: var(--shadow);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-icon svg { width:18px; height:18px; }
        
        input, select {
            width: 100%; padding: 10px 12px; border-radius: var(--radius-md); border: 1px solid var(--border-color);
            font-family: 'Cairo', sans-serif; background-color: #f8fafc; transition: var(--transition);
        }
        input:focus, select:focus { border-color: var(--primary-color); background-color: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        
        .section-card { background: var(--card-bg); padding: 25px; border-radius: var(--radius-lg); box-shadow: var(--shadow); margin-bottom: 30px; }
        .loader { border: 4px solid #e2e8f0; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .app-status { padding: 15px 20px; margin-bottom: 20px; border-radius: var(--radius-md); color: #fff; text-align: center; font-weight: 600; box-shadow: var(--shadow); display: none; align-items: center; justify-content: center; gap: 10px; }
        .app-status.error { background: #ef4444; } .app-status.success { background: #22c55e; }
        .app-status .icon svg { width: 20px; height: 20px; fill: white; }
        
        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; right: 0; bottom: 0; left: 0; background: rgba(15, 23, 42, 0.6);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: var(--transition);
        }
        .modal-overlay.is-visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-color); border-radius: var(--radius-lg); width: 90%; max-width: 600px;
            max-height: 80vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: var(--transition);
        }
        .modal-overlay.is-visible .modal-content { transform: scale(1); }
        .modal-header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); background: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        .modal-header h2 { margin: 0; font-size: 1.2rem; }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted-text); padding:0; box-shadow:none; }
        .modal-body { padding: 20px; overflow-y: auto; background: white; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); text-align: left; border-radius: 0 0 var(--radius-lg) var(--radius-lg); }
        #search-controls {
            display: flex; gap: 10px; margin-bottom: 15px; position: sticky; top: -20px; background: white; padding: 15px 0; z-index: 10;
        }
        #search-input { border: none; flex-grow: 1; padding: 5px; outline: none; background: transparent; }
        
        /* Item list inside modal */
        #item-list { border: 1px solid var(--border-color); border-radius: var(--radius-lg); background: white; }
        .item-card { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color); transition: var(--transition); cursor: pointer; position: relative; }
        .item-card:last-child { border-bottom: none; }
        .item-card:hover { background-color: #f8fafc; }
        .item-card.selected { background-color: #eff6ff; color: #1e40af; font-weight: 600; }
        .item-card.selected::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background-color: var(--primary-color); }
        .item-card input[type="radio"] { margin-left: 15px; transform: scale(1.3); accent-color: var(--primary-color); }
        .item-card .details { display: flex; flex-direction: column; min-width: 0; }
        .item-card .item-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-card .item-meta { font-size: 12px; color: var(--muted-text); }
        .item-card.selected .item-meta { color: #60a5fa; }

        /* Selected item display on main page */
        #selected-item-display { background-color: #f8fafc; padding: 20px; border-radius: var(--radius-md); border: 1px solid var(--border-color); text-align: center; margin-bottom: 15px; }
        #selected-item-display .placeholder { color: var(--muted-text); }
        #selected-item-display .item-name { font-weight: 700; font-size: 1.2rem; color: #1e3a8a; }
        #selected-item-display .item-meta { color: var(--primary-color); font-size: 0.9rem; }

        #a4-sheet { background: white; width: 21cm; height: 29.7cm; box-shadow: var(--shadow-lg); padding: 1cm; transform-origin: center center; transform: scale(0.65); display: grid; align-content: start; }
        #print-button { margin-top: 25px; }
        
        .price-label { display: flex; flex-direction: row; align-items: center; overflow: hidden; background-color: white; color: var(--text-color); font-family: 'Cairo', sans-serif; border: 1px solid #cbd5e1; border-radius: 8px; padding: 5px; }
        .label-logo-area { flex: 0 0 25%; height: 100%; }
        .label-info-area { flex: 1 1 auto; text-align: center; padding: 0 10px; font-weight: 700; font-size: var(--label-item-font-size); white-space: nowrap; overflow: hidden; }
        .label-price-area { flex: 0 0 30%; text-align: center; padding: 0 5px; }
        .label-price-container { border: 2px solid #ef4444; border-radius: 8px; text-align: center; background: white; padding: 5px 10px; display: inline-block; }
        .label-price { font-size: var(--label-price-font-size); font-weight: 700; color: #ef4444; white-space: nowrap; }

        .slider-value { font-weight: 600; color: var(--primary-color); }
        fieldset { border: none; border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; background-color: #f8fafc; border: 1px solid var(--border-color); }
        legend { font-weight: 700; color: var(--text-color); padding: 0 5px; font-size: 1.1rem; }
        .control-group { margin-bottom: 20px; } .control-group:last-child { margin-bottom: 0; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--muted-text); }
        
        .grid-2, .grid-4 { display: grid; gap: 15px; align-items: end; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        
        #layout-calculation-status, #queue-summary { background-color: #eef2ff; padding: 10px; border-radius: var(--radius-md); text-align: center; font-weight: 600; color: #4338ca; margin-top: 15px; display:none; }

        #print-queue-list { max-height: 25vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-lg); background: white; }
        .queue-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color); }
        .queue-item-details { flex-grow: 1; min-width: 0; }
        .queue-item-name { font-weight: 600; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .queue-item-meta { font-size: 14px; color: var(--muted-text); }
        .queue-item-remove { background: #fee2e2; color: #b91c1c; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0; transition: var(--transition); flex-shrink: 0; margin-right: 10px; box-shadow:none; }
        .queue-item-remove:hover { background-color: #ef4444; color: white; transform: scale(1.1); }
        
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-color); } ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        @media print {
            .control-panel, #print-button, .app-status, .modal-overlay { display: none !important; }
            body, .app-container, .preview-panel { display: block !important; width: 100% !important; height: auto !important; overflow: visible !important; background: #fff !important; padding: 0 !important; margin: 0 !important; }
            #a4-sheet { transform: none !important; box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; width: 100% !important; height: 100% !important; display: grid !important; page-break-after: always; }
            .price-label { page-break-inside: avoid !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; border: none !important; background: transparent !important; }
            .label-logo-area { visibility: hidden !important; }
            .label-price-container { border: none !important; background: transparent !important; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="preview-panel">
            <div id="a4-sheet"></div>
            <button id="print-button" style="display:none;"><span class="btn-icon"></span> طباعة</button>
        </div>
        
        <aside class="control-panel">
            <h1>شيلف مجمع</h1>
            <a href="../index.html" style="text-decoration: none; display: block; text-align: center; margin-bottom: 25px; color: #0077cc; font-weight: 500;">← العودة إلى لوحة التحكم</a>
            <div id="app-status" class="app-status"></div>

            <section class="section-card">
                <h2>1. تحميل البيانات</h2>
                <div id="loader" class="loader"></div>
            </section>

            <section id="item-selection-section" class="section-card" style="display:none;">
                <h2>2. الصنف المحدد</h2>
                <div id="selected-item-display">
                    <span class="placeholder">لم يتم تحديد أي صنف</span>
                </div>
                <button id="open-item-modal-btn" style="width: 100%;"><span class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" /></svg></span> اختر صنفاً...</button>
            </section>
            
            <section id="generation-section" class="section-card" style="display:none;">
                 <h2>3. إضافة بطاقة للقائمة</h2>
                 <div class="control-group">
                    <div class="grid-4">
                       <select id="price-category">
                           <option value="sokhna">السخنة</option>
                           <option value="sahel">الساحل</option>
                           <option value="cairo">القاهرة</option>
                       </select>
                       <input type="number" id="price-input" placeholder="السعر" step="0.01" min="0">
                       <input type="number" id="quantity-input" placeholder="الكمية" value="1" min="1">
                       <button id="add-to-queue-btn">إضافة</button>
                    </div>
                 </div>
            </section>

            <section id="print-queue-section" class="section-card" style="display:none;">
                <h2>4. قائمة الطباعة</h2>
                <div id="print-queue-list"></div>
                <div id="queue-summary" style="display: none;"></div>
            </section>

            <h3>5. تخصيص التصميم</h3>
            <fieldset>
                <legend>تخطيط الصفحة</legend>
                 <div id="layout-calculation-status"></div>
            </fieldset>

            <fieldset>
                <legend>النصوص والخطوط</legend>
                <div class="control-group grid-2">
                     <div><label>خط الصنف (px): <span id="item-font-size-value" class="slider-value">16</span></label><input type="range" id="item-font-size" min="8" max="28" value="16"></div>
                     <div><label>خط السعر (px): <span id="price-font-size-value" class="slider-value">24</span></label><input type="range" id="price-font-size" min="12" max="48" value="24"></div>
                </div>
            </fieldset>
        </aside>
    </div>

    <!-- MODAL HTML -->
    <div id="item-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>اختر صنفاً</h2>
                <button class="modal-close-btn" title="إغلاق">&times;</button>
            </div>
            <div class="modal-body">
                <div id="search-controls">
                    <select id="search-field"><option value="name">الاسم</option><option value="code">الكود</option></select>
                    <div id="search-container" style="border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 5px; display: flex; align-items: center; background-color: #f8fafc; transition: var(--transition); flex-grow: 1;">
                        <input type="search" id="search-input" placeholder="اكتب هنا للبحث...">
                    </div>
                </div>
                <div id="item-list"></div>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw_TeuaYi3odExgQNHKXj52grDm-QvPrbEJwMKibQxD8rkxff1EuX2VKmpWWKCwOBqD/exec';
    
    const icons = {
        print: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.552c.377.046.752.11 1.126.195.784.175 1.437.638 1.83 1.262.394.624.594 1.344.594 2.103v2.888c0 .76-.2 1.48-.594 2.104-.393.623-1.046 1.086-1.83 1.261-.374.086-.749.15-1.126.195v3.552C15 18.216 14.216 19 13.25 19h-6.5C5.784 19 5 18.216 5 17.25V2.75Zm.75 14.5v-2.888c0-.76.2-1.48.594-2.104.393-.623 1.046-1.086 1.83-1.261a23.99 23.99 0 0 1 2.652 0c.784.175 1.437.638 1.83 1.262.394.624.594 1.343.594 2.103v2.888a.75.75 0 0 1-.75.75h-8a.75.75 0 0 1-.75-.75Zm.75-9.75a.75.75 0 0 1 .75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1-.75-.75Zm0 3a.75.75 0 0 1 .75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg>`,
        success: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>`,
        error: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>`,
    };
    
    const state = { allItems: [], selectedItemId: null, printQueue: [] };
    
    const dom = {
        appStatus: document.getElementById('app-status'), loader: document.getElementById('loader'),
        itemSelectionSection: document.getElementById('item-selection-section'),
        selectedItemDisplay: document.getElementById('selected-item-display'),
        generationSection: document.getElementById('generation-section'),
        priceCategory: document.getElementById('price-category'), priceInput: document.getElementById('price-input'), 
        quantityInput: document.getElementById('quantity-input'), addToQueueBtn: document.getElementById('add-to-queue-btn'),
        printQueueSection: document.getElementById('print-queue-section'), printQueueList: document.getElementById('print-queue-list'),
        queueSummary: document.getElementById('queue-summary'), a4Sheet: document.getElementById('a4-sheet'), 
        printButton: document.getElementById('print-button'), layoutStatus: document.getElementById('layout-calculation-status'),
        modal: document.getElementById('item-selection-modal'),
        openModalBtn: document.getElementById('open-item-modal-btn'),
        searchInput: document.getElementById('search-input'), searchField: document.getElementById('search-field'),
        itemList: document.getElementById('item-list'),
        controls: {
            itemFontSize: document.getElementById('item-font-size'),
            priceFontSize: document.getElementById('price-font-size'),
        }
    };

    const debounce = (func, delay) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; };

    const showStatus = (message, type = 'error') => {
        const iconHtml = `<span class="icon">${type === 'success' ? icons.success : icons.error}</span>`;
        dom.appStatus.innerHTML = iconHtml + message;
        dom.appStatus.className = `app-status ${type}`;
        dom.appStatus.style.display = 'flex';
        setTimeout(() => { dom.appStatus.style.display = 'none'; }, type === 'error' ? 8000 : 4000);
    };

    const openModal = () => {
        dom.modal.classList.add('is-visible');
        setTimeout(() => dom.searchInput.focus(), 50); // Delay for transition
    };

    const closeModal = () => {
        dom.modal.classList.remove('is-visible');
    };
    
    const updatePriceForSelection = () => {
        if (state.selectedItemId === null) return;
        const selectedItem = state.allItems.find(item => item.id === state.selectedItemId);
        const category = dom.priceCategory.value;
        dom.priceInput.value = (selectedItem?.prices?.[category]?.toFixed(2)) || '';
    };
    
    const renderItems = (items) => {
        dom.itemList.innerHTML = items.length === 0 
            ? '<p style="text-align:center; padding: 20px; color: var(--muted-text);">لا توجد نتائج مطابقة</p>'
            : '';

        items.forEach(item => {
            const card = document.createElement('label');
            card.className = 'item-card';
            card.innerHTML = `<input type="radio" name="selected-item" data-id="${item.id}"><div class="details"><span class="item-name" title="${item.name}">${item.name}</span><span class="item-meta">الكود: ${item.code || 'N/A'}</span></div>`;
            card.addEventListener('change', (e) => {
                const id = parseInt(e.target.dataset.id, 10);
                state.selectedItemId = id;
                const selectedItem = state.allItems.find(i => i.id === id);
                
                dom.selectedItemDisplay.innerHTML = `<div class="item-name">${selectedItem.name}</div><div class="item-meta">الكود: ${selectedItem.code || 'N/A'}</div>`;
                dom.generationSection.style.display = 'block';
                updatePriceForSelection();
                closeModal();
            });
            dom.itemList.appendChild(card);
        });
    };
    
    const handleSearch = () => {
        const query = dom.searchInput.value.toLowerCase().trim();
        const field = dom.searchField.value;
        const filtered = query ? state.allItems.filter(item => String(item[field] || '').toLowerCase().includes(query)) : state.allItems;
        renderItems(filtered);
    };

    const renderPrintQueue = () => {
        dom.printQueueList.innerHTML = '';
        if (state.printQueue.length === 0) {
            dom.printQueueSection.style.display = 'none';
            dom.queueSummary.style.display = 'none';
        } else {
            dom.printQueueSection.style.display = 'block';
            state.printQueue.forEach(job => {
                const itemEl = document.createElement('div');
                itemEl.className = 'queue-item';
                itemEl.innerHTML = `<div class="queue-item-details"><span class="queue-item-name" title="${job.name}">${job.name}</span><span class="queue-item-meta">السعر: ${job.price.toFixed(2)} ج.م - الكمية: ${job.quantity}</span></div><button class="queue-item-remove" data-id="${job.id}" title="إزالة">&times;</button>`;
                dom.printQueueList.appendChild(itemEl);
            });
            const totalLabels = state.printQueue.reduce((sum, job) => sum + parseInt(job.quantity), 0);
            dom.queueSummary.textContent = `الإجمالي: ${totalLabels} بطاقة`;
            dom.queueSummary.style.display = 'block';
        }
    };
    
    const adjustLabelFontSize = (labelElement) => {
        const infoArea = labelElement.querySelector('.label-info-area');
        if (!infoArea) return;
        infoArea.style.fontSize = ''; 
        let currentFontSize = parseInt(window.getComputedStyle(infoArea).fontSize);
        while (infoArea.scrollWidth > infoArea.clientWidth && currentFontSize > 8) {
            currentFontSize--;
            infoArea.style.fontSize = `${currentFontSize}px`;
        }
    };

    const updatePreview = () => {
        const root = document.documentElement.style;
        root.setProperty('--label-item-font-size', `${dom.controls.itemFontSize.value}px`);
        root.setProperty('--label-price-font-size', `${dom.controls.priceFontSize.value}px`);

        const labelsPerPage = 9; // Approx 297mm / (30mm label + 5mm gap)
        dom.a4Sheet.innerHTML = '';
        dom.a4Sheet.style.gridTemplateColumns = `1fr`;
        dom.a4Sheet.style.gap = `5mm`;
        dom.a4Sheet.style.gridTemplateRows = `repeat(${labelsPerPage}, 30mm)`;
        
        const labelsToRender = state.printQueue.flatMap(job => Array(parseInt(job.quantity)).fill(job));
        
        labelsToRender.slice(0, labelsPerPage).forEach(job => {
            const label = document.createElement('div');
            label.className = 'price-label';
            label.innerHTML = `<div class="label-logo-area"></div><div class="label-info-area">${job.name}</div><div class="label-price-area"><div class="label-price-container"><div class="label-price">${job.price.toFixed(2)} ج.م</div></div></div>`;
            dom.a4Sheet.appendChild(label);
            adjustLabelFontSize(label);
        });

        const totalInQueue = state.printQueue.reduce((sum, job) => sum + parseInt(job.quantity), 0);
        dom.layoutStatus.textContent = `سعة الصفحة: ${labelsPerPage} بطاقات | القائمة تحتوي على ${totalInQueue} بطاقة.`;
        dom.layoutStatus.style.display = 'block';
        
        if (dom.printButton.querySelector('.btn-icon')) dom.printButton.querySelector('.btn-icon').innerHTML = icons.print;
        dom.printButton.style.display = labelsToRender.length > 0 ? 'inline-flex' : 'none';
    };

    const handleAddToQueue = () => {
        if (state.selectedItemId === null) return showStatus('خطأ: يرجى تحديد صنف أولاً.', 'error');
        const price = parseFloat(dom.priceInput.value);
        if (isNaN(price) || price <= 0) return showStatus('خطأ: يرجى إدخال سعر صحيح وموجب.', 'error');
        const quantity = parseInt(dom.quantityInput.value);
        if (isNaN(quantity) || quantity < 1) return showStatus('خطأ: يرجى إدخال كمية صحيحة.', 'error');
        
        const selectedItem = state.allItems.find(item => item.id === state.selectedItemId);
        state.printQueue.push({ id: Date.now(), name: selectedItem.name, price, quantity });
        
        // Reset UI
        state.selectedItemId = null;
        dom.selectedItemDisplay.innerHTML = `<span class="placeholder">لم يتم تحديد أي صنف</span>`;
        dom.generationSection.style.display = 'none';
        dom.quantityInput.value = '1';
        
        renderPrintQueue();
        updatePreview();
        showStatus(`تمت إضافة "${selectedItem.name}" للقائمة.`, 'success');
    };

    const loadData = async () => {
        dom.loader.style.display = 'block';
        try {
            const response = await fetch(WEB_APP_URL);
            if (!response.ok) throw new Error(`فشل الاتصال بالخادم (Status: ${response.status})`);
            const data = await response.json();
            if (data.error) throw new Error(data.message);
            
            state.allItems = data.map((item, index) => ({ ...item, id: item.id ?? index }));
            
            if (state.allItems.length > 0) {
                showStatus(`تم تحميل ${state.allItems.length} صنف بنجاح.`, 'success');
                dom.itemSelectionSection.style.display = 'block';
                renderItems(state.allItems);
                updatePreview();
            } else {
                 showStatus('لم يتم العثور على بيانات.', 'error');
            }
        } catch (error) {
            showStatus(`فشل تحميل البيانات: ${error.message}.`, 'error');
        } finally {
            dom.loader.style.display = 'none';
        }
    };
    
    // --- EVENT LISTENERS ---
    const debouncedSearch = debounce(handleSearch, 250);
    const debouncedUpdatePreview = debounce(updatePreview, 250);
    
    dom.openModalBtn.addEventListener('click', openModal);
    dom.modal.addEventListener('click', (e) => { if (e.target === dom.modal || e.target.classList.contains('modal-close-btn')) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    dom.addToQueueBtn.addEventListener('click', handleAddToQueue);
    dom.printButton.addEventListener('click', () => window.print());
    dom.printQueueList.addEventListener('click', e => {
        if (e.target.closest('.queue-item-remove')) {
            const jobId = parseInt(e.target.closest('.queue-item-remove').dataset.id, 10);
            state.printQueue = state.printQueue.filter(job => job.id !== jobId);
            renderPrintQueue();
            updatePreview();
        }
    });

    dom.searchInput.addEventListener('input', debouncedSearch);
    dom.searchField.addEventListener('change', handleSearch);
    dom.priceCategory.addEventListener('change', updatePriceForSelection);
    
    Object.values(dom.controls).forEach(c => c.addEventListener('input', debouncedUpdatePreview));
    
    ['item-font-size', 'price-font-size'].forEach(id => {
        const input = document.getElementById(id), valueSpan = document.getElementById(`${id}-value`);
        if(input && valueSpan) {
            valueSpan.textContent = input.value;
            input.addEventListener('input', e => valueSpan.textContent = e.target.value);
        }
    });
    
    loadData();
});
</script>
</body>
</html>
